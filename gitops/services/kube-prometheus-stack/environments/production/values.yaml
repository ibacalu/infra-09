# -----------------------------------------------------------------------------
# Grafana Configuration
# -----------------------------------------------------------------------------
grafana:
  adminUser: admin
  adminPassword: secretPassword
  defaultDashboardsTimezone: Europe/Berlin
  persistence:
    enabled: true
    storageClassName: gp2
    type: sts
    size: 5Gi

  # Enable sidecar to discover dashboards and alerts from ConfigMaps
  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
      searchNamespace: ALL
    alerts:
      enabled: true
      label: grafana_alert
      labelValue: "1"
      searchNamespace: ALL

  # Configure Grafana Unified Alerting to forward to Alertmanager
  alerting:
    contactpoints.yaml:
      apiVersion: 1
      contactPoints:
        - orgId: 1
          name: alertmanager
          receivers:
            - uid: alertmanager-receiver
              type: prometheus-alertmanager
              settings:
                url: http://alertmanager-operated.monitoring.svc:9093
                # Send resolved notifications
                sendResolved: true
    
    policies.yaml:
      apiVersion: 1
      policies:
        - orgId: 1
          receiver: alertmanager
          group_by: ['alertname', 'job', 'namespace']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h
  
  grafana.ini:
    unified_alerting:
      enabled: true

# -----------------------------------------------------------------------------
# Kube-State-Metrics Configuration
# Enable job metrics and whitelist Dagster labels for pipeline tracking
# -----------------------------------------------------------------------------
kube-state-metrics:
  # Expose Dagster labels as metric labels for alerting
  metricLabelsAllowlist:
    - jobs=[dagster/job,dagster/run-id,dagster/code-location]


# -----------------------------------------------------------------------------
# Prometheus Configuration  
# Allow discovery of PrometheusRules from all namespaces
# -----------------------------------------------------------------------------
prometheus:
  prometheusSpec:
    ruleNamespaceSelector: {}
    ruleSelector: {}
    ruleSelectorNilUsesHelmValues: false

# -----------------------------------------------------------------------------
# Alertmanager Configuration
# Single source of truth for all alert routing → PagerDuty
# -----------------------------------------------------------------------------
alertmanager:
  enabled: true
  
  # Mount the PagerDuty secret
  alertmanagerSpec:
    secrets:
      - pagerduty-key
  
  config:
    global:
      resolve_timeout: 5m
    
    route:
      receiver: 'pagerduty-critical'
      group_by: ['alertname', 'namespace', 'job', 'label_dagster_job', 'job_name']
      group_wait: 10s
      group_interval: 5m
      repeat_interval: 4h
      routes:
        # Critical alerts → PagerDuty
        - match:
            severity: critical
          receiver: 'pagerduty-critical'
        # Warning alerts → PagerDuty (lower urgency)
        - match:
            severity: warning
          receiver: 'pagerduty-warning'
        # Info alerts → null (don't page for info)
        - match:
            severity: info
          receiver: 'null'
    
    receivers:
      - name: 'pagerduty-critical'
        pagerduty_configs:
          - routing_key_file: /etc/alertmanager/secrets/pagerduty-key/key
            severity: critical
            # Use CommonAnnotations/CommonLabels for receiver templates
            description: '{{ .CommonAnnotations.summary }}'
            details:
              alertname: '{{ .CommonLabels.alertname }}'
              namespace: '{{ .CommonLabels.namespace }}'
              job: '{{ .CommonLabels.job }}'
              description: '{{ .CommonAnnotations.description }}'
      
      - name: 'pagerduty-warning'
        pagerduty_configs:
          - routing_key_file: /etc/alertmanager/secrets/pagerduty-key/key
            severity: warning
            description: '{{ .CommonAnnotations.summary }}'
      
      - name: 'null'
        # Null receiver - alerts are acknowledged but not routed

