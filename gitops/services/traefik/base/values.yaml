#? Traefik Configuration
#? Ref: https://github.com/traefik/traefik-helm-chart

providers:
  # -- Load Kubernetes IngressRoute provider
  kubernetesCRD:
    enabled: true
    # ingressClass: traefik

  # -- Load Kubernetes Ingress provider
  kubernetesIngress:
    enabled: true
    # ingressClass: traefik

ingressRoute:
  dashboard:
    enabled: true

ingressClass:
  enabled: true
  isDefaultClass: true

# -- Using Cert-Manager for certificates
# persistence:
#   enabled: false
#   name: data
#   accessMode: ReadWriteOnce
#   size: 256Mi
#   path: /data

# certificatesResolvers:
#   cloudflare:
#     acme:
#       email: $(secret:argocd/traefik#CF_EMAIL)
#       storage: /data/acme-cloudflare.json
#       dnsChallenge:
#         provider: cloudflare
#         resolvers:
#           - 1.1.1.1
# env:
#   - name: CF_DNS_API_TOKEN
#     value: $(secret:argocd/traefik#CF_DNS_API_TOKEN)

ports:
  web:
    expose:
      default: true
    exposedPort: 80
    # redirections:
    #   entryPoint:
    #     to: websecure
    #     scheme: https
    #     permanent: true
  websecure:
    expose:
      default: true
    exposedPort: 443
    tls:
      enabled: true
      # certResolver: cloudflare
  public-http:
    port: 9080
    expose:
      public: true
    exposedPort: 80
    protocol: TCP
  public-https:
    port: 9443
    hostPort:  # @schema type:[integer, null]; minimum:0
    containerPort:  # @schema type:[integer, null]; minimum:0
    expose:
      public: true
    exposedPort: 443
    ## -- Different target traefik port on the cluster, useful for IP type LB
    targetPort: 9443
    ## -- The port protocol (TCP/UDP)
    protocol: TCP
    # -- See [upstream documentation](https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport)
    nodePort:  # @schema type:[integer, null]; minimum:0
    # -- See [upstream documentation](https://kubernetes.io/docs/concepts/services-networking/service/#application-protocol)
    appProtocol:  # @schema type:[string, null]
    # -- See [upstream documentation](https://doc.traefik.io/traefik/routing/entrypoints/#allowacmebypass)
    allowACMEByPass: false
    http3:
      ## -- Enable HTTP/3 on the entrypoint
      ## Enabling it will also enable http3 experimental feature
      ## https://doc.traefik.io/traefik/routing/entrypoints/#http3
      ## There are known limitations when trying to listen on same ports for
      ## TCP & UDP (Http3). There is a workaround in this chart using dual Service.
      ## https://github.com/kubernetes/kubernetes/issues/47249#issuecomment-587960741
      enabled: false
      advertisedPort:  # @schema type:[integer, null]; minimum:0
    forwardedHeaders:
        # -- Trust forwarded headers information (X-Forwarded-*).
      trustedIPs: []
      insecure: false
    proxyProtocol:
      # -- Enable the Proxy Protocol header parsing for the entry point
      trustedIPs: []
      insecure: false
    # -- See [upstream documentation](https://doc.traefik.io/traefik/routing/entrypoints/#transport)
    transport:
      respondingTimeouts:
        readTimeout:   # @schema type:[string, integer, null]
        writeTimeout:  # @schema type:[string, integer, null]
        idleTimeout:   # @schema type:[string, integer, null]
      lifeCycle:
        requestAcceptGraceTimeout:  # @schema type:[string, integer, null]
        graceTimeOut:               # @schema type:[string, integer, null]
      keepAliveMaxRequests:         # @schema type:[integer, null]; minimum:0
      keepAliveMaxTime:             # @schema type:[string, integer, null]
    # --  See [upstream documentation](https://doc.traefik.io/traefik/routing/entrypoints/#tls)
    tls:
      enabled: true
      options: ""
      certResolver: ""
      domains: []
    # -- One can apply Middlewares on an entrypoint
    # https://doc.traefik.io/traefik/middlewares/overview/
    # https://doc.traefik.io/traefik/routing/entrypoints/#middlewares
    # -- /!\ It introduces here a link between your static configuration and your dynamic configuration /!\
    # It follows the provider naming convention: https://doc.traefik.io/traefik/providers/overview/#provider-namespace
    #   - namespace-name1@kubernetescrd
    #   - namespace-name2@kubernetescrd
    middlewares: []

# IngressRoute use certificate by default
tlsStore:
  default:
    defaultCertificate:
      secretName: wildcard-cert-tls

globalArguments:
  - "--global.checknewversion=false"
  - "--global.sendanonymoususage=false"

logs:
  general:
    level: DEBUG
  access:
    enabled: false

service:
  enabled: true
  single: true
  type: LoadBalancer
  annotations:
    external-dns.alpha.kubernetes.io/hostname: $(configmap:argocd/cluster-config#clusterDNSZoneName)
    metallb.io/loadBalancerIPs: "$(secret:argocd/traefik#private-metallb-ip)"
  annotationsTCP: {}
  annotationsUDP: {}
  spec:
    externalTrafficPolicy: Local
  externalIPs:
    - "$(secret:argocd/traefik#private-metallb-ip)"
  
  additionalServices:
    public:
      type: LoadBalancer
      annotations:
        metallb.io/loadBalancerIPs: "$(secret:argocd/traefik#public-metallb-ip)"
      annotationsTCP: {}
      annotationsUDP: {}
      spec:
        externalTrafficPolicy: Local
      externalIPs:
        - "$(secret:argocd/traefik#public-metallb-ip)"
