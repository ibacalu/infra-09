apiVersion: 1
groups:
  - orgId: 1
    name: dagster-job-alerts
    folder: Dagster
    interval: 1m
    rules:
      - uid: dagster-job-failed
        title: Dagster Job Failed
        condition: C
        data:
          # Query: time since last failure (in seconds)
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: time() - dagster_job_last_run_timestamp{status="failure"}
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          # Reduce to single value
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: reduce
          # Threshold: alert if failure happened in last 5 minutes (300s)
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
              conditions:
                - evaluator:
                    params:
                      - 300
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
        for: 0m
        annotations:
          summary: "Dagster pipeline {{ $labels.job }} failed"
          description: |
            A Dagster job has failed and requires attention.
            
            **Job**: {{ $labels.job }}
            
            Check the Dagster UI for error details and logs.
          runbook_url: "https://github.com/ibacalu/infra-09/blob/main/docs/runbooks/dagster-job-failure.md"
        labels:
          severity: critical
          service: dagster
          team: data-engineering
