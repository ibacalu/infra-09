apiVersion: 1
groups:
  - orgId: 1
    name: dagster-job-alerts
    folder: Dagster
    interval: 1m
    rules:
      - uid: dagster-job-failed
        title: Dagster Job Failed
        condition: C
        data:
          # Query A: Alert if failure is more recent than success
          # Returns 1 if last failure > last success, 0 otherwise
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                dagster_job_last_run_timestamp{status="failure"} 
                > ignoring(status) 
                dagster_job_last_run_timestamp{status="success"}
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          # Query B: Reduce to single value per job
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: B
              type: reduce
          # Query C: Alert if result is 1 (failure more recent than success)
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
              conditions:
                - evaluator:
                    params:
                      - 0.5
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
        noDataState: OK
        execErrState: OK
        for: 0m
        annotations:
          summary: "Dagster pipeline {{ $labels.job }} failed"
          description: |
            A Dagster job has failed and requires attention.
            
            **Job**: {{ $labels.job }}
            
            The last run of this job was a failure. A successful re-run will auto-resolve this alert.
            
            Check the Dagster UI for error details and logs.
          runbook_url: "https://github.com/ibacalu/infra-09/blob/main/docs/runbooks/dagster-job-failure.md"
        labels:
          severity: critical
          service: dagster
          team: data-engineering
