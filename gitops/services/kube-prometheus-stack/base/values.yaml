prometheusOperator:
  resources:
    limits:
      cpu: 200m
      memory: 200Mi
    requests:
      cpu: 100m
      memory: 100Mi
  admissionWebhooks:
    certManager:
      enabled: true

# Alertmanager - simplified config (Grafana handles PagerDuty alerts)
alertmanager:
  alertmanagerSpec:
    resources:
      limits:
        cpu: 200m
        memory: 400Mi
      requests:
        cpu: 100m
        memory: 200Mi
  config:
    global:
      resolve_timeout: 5m
    inhibit_rules:
      - source_matchers:
          - 'severity = critical'
        target_matchers:
          - 'severity =~ warning|info'
        equal:
          - 'namespace'
          - 'alertname'
    route:
      group_by: ['namespace', 'alertname']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'null'
      routes:
        - receiver: 'null'
          matchers:
            - alertname = "Watchdog"
    receivers:
      - name: 'null'
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: "$(configmap:argocd/cluster-config#cluster-issuer)"
    hosts:
      - alertmanager.$(configmap:argocd/cluster-config#clusterDNSZoneName)
    tls:
      - secretName: alertmanager-tls
        hosts:
          - alertmanager.$(configmap:argocd/cluster-config#clusterDNSZoneName)

kubelet:
  serviceMonitor:
    additionalLabels:
      cluster: $(configmap:argocd/cluster-config#cluster_name)

prometheus:
  prometheusSpec:
    resources:
      limits:
        cpu: 200m
        memory: 400Mi
      requests:
        cpu: 100m
        memory: 200Mi
    externalLabels:
      cluster: "$(configmap:argocd/cluster-config#cluster_name)"
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: "$(configmap:argocd/cluster-config#cluster-issuer)"
    hosts:
      - prometheus.$(configmap:argocd/cluster-config#clusterDNSZoneName)
    tls:
      - secretName: prometheus-tls
        hosts:
          - prometheus.$(configmap:argocd/cluster-config#clusterDNSZoneName)

thanosRuler:
  thanosRulerSpec:
    resources:
      limits:
        cpu: 200m
        memory: 400Mi
      requests:
        cpu: 100m
        memory: 200Mi

coreDns:
  enabled: true
  service:
    enabled: true
    port: 9153
    targetPort: 9153
    ipDualStack:
      enabled: false
  serviceMonitor:
    port: metrics
    selector:
      matchLabels:
        k8s-app: kube-dns

# Grafana with Alerting and PagerDuty integration
grafana:
  enabled: true
  adminUser: admin
  adminPassword: secretPassword
  defaultDashboardsTimezone: Europe/Berlin
  persistence:
    enabled: true
    storageClassName: gp2
    type: sts
    size: 5Gi
  
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: "$(configmap:argocd/cluster-config#cluster-issuer)"
    hosts:
      - grafana.$(configmap:argocd/cluster-config#clusterDNSZoneName)
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana.$(configmap:argocd/cluster-config#clusterDNSZoneName)
  
  # Enable Grafana Alerting
  alerting:
    contactpoints.yaml:
      apiVersion: 1
      contactPoints:
        - orgId: 1
          name: pagerduty
          receivers:
            - uid: pagerduty-dagster
              type: pagerduty
              settings:
                integrationKey: $__file{/etc/secrets/pagerduty/key}
                severity: critical
                class: dagster

    policies.yaml:
      apiVersion: 1
      policies:
        - orgId: 1
          receiver: pagerduty
          group_by: ['alertname', 'job']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h

    rules.yaml:
      apiVersion: 1
      groups:
        - orgId: 1
          name: dagster
          folder: Dagster
          interval: 1m
          rules:
            - uid: dagster-job-failed
              title: Dagster Job Failed
              condition: C
              data:
                # Query: time since last failure (in seconds)
                - refId: A
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: prometheus
                  model:
                    expr: time() - dagster_job_last_run_timestamp{status="failure"}
                    intervalMs: 1000
                    maxDataPoints: 43200
                    refId: A
                # Reduce to single value
                - refId: B
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: __expr__
                  model:
                    datasource:
                      type: __expr__
                      uid: __expr__
                    expression: A
                    intervalMs: 1000
                    maxDataPoints: 43200
                    reducer: last
                    refId: B
                    type: reduce
                # Threshold: alert if failure happened in last 5 minutes (300s)
                - refId: C
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: __expr__
                  model:
                    datasource:
                      type: __expr__
                      uid: __expr__
                    expression: B
                    intervalMs: 1000
                    maxDataPoints: 43200
                    refId: C
                    type: threshold
                    conditions:
                      - evaluator:
                          params:
                            - 300
                          type: lt
                        operator:
                          type: and
                        query:
                          params:
                            - C
                        reducer:
                          params: []
                          type: last
                        type: query
              for: 0m
              annotations:
                summary: 'Dagster job {{ "{{" }} $labels.job {{ "}}" }} failed'
                description: 'A Dagster job has failed. Check the Dagster UI for details.'
              labels:
                severity: critical

  # Mount PagerDuty secret for alerting
  extraSecretMounts:
    - name: pagerduty-secret
      mountPath: /etc/secrets/pagerduty
      secretName: grafana-pagerduty
      readOnly: true

  # Grafana configuration via grafana.ini
  grafana.ini:
    unified_alerting:
      enabled: true

  # Provision dashboards from ConfigMaps
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'dagster'
          orgId: 1
          folder: 'Dagster'
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/dagster

  # Dashboard ConfigMaps - mount from sidecar
  dashboardsConfigMaps:
    dagster: "grafana-dashboard-dagster"

nodeExporter:
  enabled: true
  operatingSystems:
    linux:
      enabled: true
    aix:
      enabled: false
    darwin:
      enabled: false
